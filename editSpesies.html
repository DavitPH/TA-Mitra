<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Data Spesies</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* Set Poppins as the primary font for the entire body */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f0f2f5;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Styling for the fixed sidebar */
        .fixed-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 50;
        }

        /* Adjust main content margin to prevent overlap with fixed sidebar */
        .main-content-margin {
            margin-left: 16rem;
        }

        /* Styling for the Leaflet map container */
        #miniMap {
            height: 256px;
            width: 100%;
            border-radius: 0.5rem;
            background-color: #f8f8f8;
        }

        /* Notification styling */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            display: none;
            /* Hidden by default */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .fixed-sidebar {
                position: relative;
                width: 100%;
                height: auto;
                border-radius: 0;
            }

            .main-content-margin {
                margin-left: 0;
            }

            .flex-col.md\:flex-row {
                flex-direction: column;
            }

            .mr-0.md\:mr-4 {
                margin-right: 0;
            }

            .mb-4.md\:mb-0 {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>

<body class="flex min-h-screen">

    <aside class="w-64 bg-green-700 text-white flex flex-col p-4 rounded-r-lg shadow-lg fixed-sidebar">
        <div class="flex items-center justify-center mb-10 mt-4">
            <div class="w-20 h-20 flex items-center justify-center p-2">
                <img src="logo.png" alt="Snail Logo" class="w-full h-full object-contain">
            </div>
        </div>
        <nav class="flex-grow">
            <ul>
                <li class="mb-4">
                    <a href="daftarSpesies.html" class="flex items-center p-3 rounded-lg bg-green-800 shadow-md">
                        <i class="fas fa-bug text-xl mr-3"></i>
                        <span class="font-medium text-lg">Invertebrata</span>
                    </a>
                </li>
                <li class="mb-4">
                    <a href="daftarKlasifikasi.html"
                        class="flex items-center p-3 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-sitemap text-xl mr-3"></i>
                        <span class="font-medium text-lg">Klasifikasi</span>
                    </a>
                </li>
                <li class="mb-4">
                    <a href="daftarKomentar.html"
                        class="flex items-center p-3 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-comment-alt text-xl mr-3"></i>
                        <span class="font-medium text-lg">Komentar</span>
                    </a>
                </li>
                <li class="mb-4">
                    <a href="daftarAkun.html"
                        class="flex items-center p-3 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-users text-xl mr-3"></i>
                        <span class="font-medium text-lg">Akun Pengguna</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto pt-4 border-t border-green-600">
            <a href="index.html" class="flex items-center p-3 rounded-lg hover:bg-green-600 transition-colors">
                <i class="fas fa-sign-out-alt text-xl mr-3"></i>
                <span class="font-medium text-lg">Logout</span>
            </a>
        </div>
    </aside>

    <main class="flex-1 p-8 main-content-margin">
        <nav class="mb-6 text-gray-600 text-lg">
            <a href="daftarSpesies.html" class="hover:underline">Daftar Spesies</a>
            <span class="mx-2 font-bold text-gray-800">&gt;</span>
            <span class="font-semibold text-gray-800" id="breadcrumbTitle">Edit Data</span>
        </nav>

        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800" id="headerTitle">Edit Data Spesies</h1>
        </header>

        <div id="notification" class="notification text-white font-semibold"></div>

        <section class="bg-white p-8 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Nama Spesies</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="nama_umum" class="block text-gray-700 text-sm font-medium mb-2">Nama Umum</label>
                    <input type="text" id="nama_umum"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                        placeholder="Nama Umum">
                </div>
                <div>
                    <label for="nama_latin" class="block text-gray-700 text-sm font-medium mb-2">Nama Latin</label>
                    <input type="text" id="nama_latin"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                        placeholder="Nama Latin">
                </div>
            </div>

            <h2 class="text-xl font-semibold text-gray-800 mb-6">Klasifikasi</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div>
                    <label for="filum" class="block text-gray-700 text-sm font-medium mb-2">Phylum</label>
                    <select id="filum"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        <option value="">Pilih Phylum</option>
                    </select>
                </div>
                <div>
                    <label for="sub_filum" class="block text-gray-700 text-sm font-medium mb-2">Sub Phylum</label>
                    <select id="sub_filum"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        <option value="">Pilih Sub Phylum</option>
                    </select>
                </div>
                <div>
                    <label for="kelas" class="block text-gray-700 text-sm font-medium mb-2">Kelas</label>
                    <select id="kelas"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        <option value="">Pilih Kelas</option>
                    </select>
                </div>
            </div>
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Gambar</h2>
            <div class="flex flex-col space-y-4 mb-8">
                <label for="imageUpload"
                    class="flex items-center space-x-3 bg-gray-100 p-4 rounded-lg border border-gray-300 w-full max-w-sm cursor-pointer hover:bg-gray-200 transition-colors">
                    <i class="fas fa-folder text-xl text-gray-500"></i>
                    <span class="text-gray-700">Pilih Gambar</span>
                    <span class="text-gray-500 text-sm">.jpg, .png</span>
                    <input type="file" id="imageUpload" class="hidden" accept="image/jpeg, image/png" multiple>
                </label>
                <div id="imagePreviewContainer" class="flex flex-wrap gap-4 w-full">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Deskripsi</h2>
                    <textarea id="deskripsi"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all h-32"
                        placeholder="Deskripsi"></textarea>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Habitat</h2>
                    <textarea id="habitat"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all h-32"
                        placeholder="Habitat"></textarea>
                </div>
            </div>

            <h2 class="text-xl font-semibold text-gray-800 mb-6">Peta Persebaran</h2>
            <div class="flex flex-wrap gap-4 mb-4">
                <button
                    class="flex items-center px-6 py-3 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 transition-colors"
                    id="addMapButton">
                    <i class="fas fa-plus mr-2"></i>
                    Tambah Peta
                </button>
                <button
                    class="flex items-center px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-colors"
                    id="viewAllMapsButton">
                    <i class="fas fa-globe mr-2"></i>
                    Lihat Semua Peta
                </button>
            </div>

            <div id="mapListContainer" class="space-y-4 mb-8">
            </div>
            <div id="miniMap" class="border border-gray-300 rounded-lg mb-8">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Peran Ekologis</h2>
                    <textarea id="peran_ekologis"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all h-32"
                        placeholder="Peran Ekologis"></textarea>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Status Konservasi</h2>
                    <select id="status_konservasi"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        <option value="">Pilih Status Konservasi</option>
                        <option value="EX">Extinct (EX)</option>
                        <option value="EW">Extinct in the Wild (EW)</option>
                        <option value="CR">Critically Endangered (CR)</option>
                        <option value="EN">Endangered (EN)</option>
                        <option value="VU">Vulnerable (VU)</option>
                        <option value="NT">Near Threatened (NT)</option>
                        <option value="LC">Least Concern (LC)</option>
                        <option value="DD">Data Deficient (DD)</option>
                        <option value="NE">Not Evaluated (NE)</option>
                    </select>
                </div>
            </div>

            <h2 class="text-xl font-semibold text-gray-800 mb-6">Sumber Data</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="nama_peneliti" class="block text-gray-700 text-sm font-medium mb-2">Nama
                        Peneliti</label>
                    <input type="text" id="nama_peneliti"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                        placeholder="Nama Peneliti">
                </div>
                <div>
                    <label for="lokasi_penelitian" class="block text-gray-700 text-sm font-medium mb-2">Lokasi
                        Penelitian</label>
                    <input type="text" id="lokasi_penelitian"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                        placeholder="Lokasi Penelitian">
                </div>
                <div>
                    <label for="metode_penelitian" class="block text-gray-700 text-sm font-medium mb-2">Metode
                        Penelitian</label>
                    <input type="text" id="metode_penelitian"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-500 focus:border-transparent transition-all"
                        placeholder="Metode Penelitian">
                </div>
                <div>
                    <label for="tanggal_penelitian" class="block text-gray-700 text-sm font-medium mb-2">Tanggal
                        Penelitian</label>
                    <input type="date" id="tanggal_penelitian"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                </div>
            </div>

            <div class="flex justify-end space-x-4">
                <button id="cancelButton"
                    class="px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition-colors">
                    Batal
                </button>
                <button id="saveButton"
                    class="px-6 py-3 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 transition-colors">
                    Simpan Perubahan
                </button>
            </div>
        </section>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const addMapButton = document.getElementById('addMapButton');
            const viewAllMapsButton = document.getElementById('viewAllMapsButton');
            const mapListContainer = document.getElementById('mapListContainer');
            const saveButton = document.getElementById('saveButton');
            const cancelButton = document.getElementById('cancelButton');
            const imageUploadInput = document.getElementById('imageUpload');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const notificationDiv = document.getElementById('notification');

            // Select elements for classification dropdowns
            const filumSelect = document.getElementById('filum');
            const subFilumSelect = document.getElementById('sub_filum');
            const kelasSelect = document.getElementById('kelas');

            let imageCounter = 0;
            let currentImages = [];
            let editIndex = null;
            let currentMapGeoJSON = [];
            let allClassificationRecords = [];

            // Define the string used for "no subphylum" in data (must match daftarKlasifikasi.html and tambahPhylum.html)
            const NO_SUBPHYLUM_DATA_VALUE = "Tidak Ada Sub Phylum";

            function showNotification(message, type = 'success') {
                notificationDiv.textContent = message;
                notificationDiv.className = 'notification text-white font-semibold';

                if (type === 'success') {
                    notificationDiv.classList.add('bg-green-500');
                } else if (type === 'error') {
                    notificationDiv.classList.add('bg-red-500');
                } else {
                    notificationDiv.classList.add('bg-gray-500');
                }

                notificationDiv.style.display = 'block';
                setTimeout(() => {
                    notificationDiv.style.display = 'none';
                }, 3000);
            }

            // --- REMOVED NOTIFICATION DISPLAY ON THIS PAGE ---
            // const notificationMessage = sessionStorage.getItem('notificationMessage');
            // const notificationType = sessionStorage.getItem('notificationType');
            // if (notificationMessage && notificationType) {
            //     showNotification(notificationMessage, notificationType);
            //     sessionStorage.removeItem('notificationMessage');
            //     sessionStorage.removeItem('notificationType');
            // }

            // Function to load and parse classification data from sessionStorage
            function loadClassificationOptions() {
                const storedClassificationData = sessionStorage.getItem('allClassificationRecords');
                if (storedClassificationData) {
                    try {
                        allClassificationRecords = JSON.parse(storedClassificationData);
                        // Normalisasi data untuk memastikan format konsisten
                        allClassificationRecords.forEach(item => {
                            if (!Array.isArray(item.sub_phylum)) {
                                item.sub_phylum = item.sub_phylum ? [{ name: item.sub_phylum, kelas: [] }] : [];
                            } else {
                                item.sub_phylum = item.sub_phylum.map(sp => {
                                    if (typeof sp === 'string') {
                                        return { name: sp, kelas: [] };
                                    }
                                    if (!Array.isArray(sp.kelas)) {
                                        sp.kelas = sp.kelas ? [sp.kelas] : [];
                                    }
                                    return sp;
                                });
                            }
                            // Hapus kelas di level phylum jika ada, karena sekarang sudah di dalam sub_phylum
                            if (item.kelas) {
                                delete item.kelas;
                            }
                        });
                        populatePhylum();
                    } catch (e) {
                        console.error('Error parsing classification data from sessionStorage:', e);
                        allClassificationRecords = [];
                        showNotification('Gagal memuat data klasifikasi.', 'error');
                    }
                } else {
                    allClassificationRecords = [];
                    showNotification('Belum ada data klasifikasi.', 'info');
                }
            }

            // Function to populate Phylum dropdown
            function populatePhylum() {
                filumSelect.innerHTML = '<option value="">Pilih Phylum</option>';
                subFilumSelect.innerHTML = '<option value="">Pilih Sub Phylum</option>';
                kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>';

                const uniquePhylums = new Set();
                allClassificationRecords.forEach(item => {
                    if (item.phylum) {
                        uniquePhylums.add(item.phylum);
                    }
                });

                uniquePhylums.forEach(phylum => {
                    const option = document.createElement('option');
                    option.value = phylum;
                    option.textContent = phylum;
                    filumSelect.appendChild(option);
                });
            }

            // Function to populate Sub Phylum dropdown based on selected Phylum
            function populateSubPhylum() {
                subFilumSelect.innerHTML = '<option value="">Pilih Sub Phylum</option>';
                kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>';

                const selectedPhylum = filumSelect.value;
                if (!selectedPhylum) return;

                const phylumEntry = allClassificationRecords.find(item => item.phylum === selectedPhylum);

                if (phylumEntry && Array.isArray(phylumEntry.sub_phylum) && phylumEntry.sub_phylum.length > 0) {
                    phylumEntry.sub_phylum.forEach(subPhylumObj => {
                        const option = document.createElement('option');
                        option.value = subPhylumObj.name;
                        option.textContent = subPhylumObj.name;
                        subFilumSelect.appendChild(option);
                    });
                } else {
                    const noSubPhylumOption = document.createElement('option');
                    noSubPhylumOption.value = NO_SUBPHYLUM_DATA_VALUE; // Use the specific string value
                    noSubPhylumOption.textContent = "Tidak Ada Sub Phylum";
                    subFilumSelect.appendChild(noSubPhylumOption);
                    subFilumSelect.value = NO_SUBPHYLUM_DATA_VALUE; // Automatically select this option
                }
            }

            // Function to populate Kelas dropdown based on selected Phylum and Sub Phylum
            function populateKelas() {
                kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>';

                const selectedPhylum = filumSelect.value;
                const selectedSubPhylumName = subFilumSelect.value;
                if (!selectedPhylum) return;

                const phylumEntry = allClassificationRecords.find(item => item.phylum === selectedPhylum);

                if (phylumEntry && Array.isArray(phylumEntry.sub_phylum)) {
                    const selectedSubPhylumObj = phylumEntry.sub_phylum.find(sp => sp.name === selectedSubPhylumName);

                    if (selectedSubPhylumObj && Array.isArray(selectedSubPhylumObj.kelas)) {
                        selectedSubPhylumObj.kelas.forEach(kelasName => {
                            const option = document.createElement('option');
                            option.value = kelasName;
                            option.textContent = kelasName;
                            kelasSelect.appendChild(option);
                        });
                    }
                }
            }

            // Event Listeners for classification dropdown changes
            filumSelect.addEventListener('change', () => {
                populateSubPhylum();
                // No need to check subFilumSelect.value, populateKelas will handle empty sub_filum
                populateKelas();
            });
            subFilumSelect.addEventListener('change', populateKelas);

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('editIndex')) {
                editIndex = parseInt(urlParams.get('editIndex'));

                const allSpeciesRecordsString = sessionStorage.getItem('allSpeciesRecords');
                if (allSpeciesRecordsString) {
                    try {
                        const allSpeciesRecords = JSON.parse(allSpeciesRecordsString);
                        const speciesData = allSpeciesRecords[editIndex];

                        if (speciesData) {
                            document.getElementById('nama_umum').value = speciesData.nama_umum || '';
                            document.getElementById('nama_latin').value = speciesData.nama_latin || '';
                            document.getElementById('deskripsi').value = speciesData.deskripsi || '';
                            document.getElementById('habitat').value = speciesData.habitat || '';
                            document.getElementById('peran_ekologis').value = speciesData.peran_ekologis || '';
                            document.getElementById('status_konservasi').value = speciesData.status_konservasi || '';
                            document.getElementById('nama_peneliti').value = speciesData.nama_peneliti || '';
                            document.getElementById('lokasi_penelitian').value = speciesData.lokasi_penelitian || '';
                            document.getElementById('metode_penelitian').value = speciesData.metode_penelitian || '';
                            document.getElementById('tanggal_penelitian').value = speciesData.tanggal_penelitian || '';

                            currentImages = speciesData.gambar || [];
                            renderImagePreviews();

                            currentMapGeoJSON = speciesData.peta_persebaran || [];
                            console.log('Loaded species map data for edit mode:', currentMapGeoJSON);

                            loadClassificationOptions();

                            // Set selected values for dropdowns after they are populated
                            // Menggunakan setTimeout untuk memastikan DOM sudah update setelah populatePhylum
                            setTimeout(() => {
                                filumSelect.value = speciesData.filum || '';
                                populateSubPhylum(); // Repopulate Sub Phylum based on loaded Phylum
                                setTimeout(() => {
                                    subFilumSelect.value = speciesData.sub_filum || ''; // Set Sub Phylum
                                    populateKelas(); // Repopulate Kelas based on loaded Phylum and Sub Phylum
                                    setTimeout(() => {
                                        kelasSelect.value = speciesData.kelas || ''; // Set Kelas
                                    }, 50); // Small delay
                                }, 50); // Small delay
                            }, 50); // Small delay

                        } else {
                            console.error('Data spesies tidak ditemukan untuk indeks ini:', editIndex);
                            showNotification('Data spesies tidak ditemukan.', 'error');
                            window.location.href = 'daftarSpesies.html';
                        }
                    } catch (e) {
                        console.error('Error parsing allSpeciesRecords from sessionStorage:', e);
                        showNotification('Terjadi kesalahan saat memuat data spesies.', 'error');
                        window.location.href = 'daftarSpesies.html';
                    }
                } else {
                    console.log('Tidak ada record spesies di sessionStorage.');
                    showNotification('Tidak ada data spesies untuk diedit.', 'error');
                    window.location.href = 'daftarSpesies.html';
                }
            } else {
                console.error('Tidak ada editIndex yang ditemukan di URL. Mengarahkan ke daftar spesies.');
                window.location.href = 'daftarSpesies.html';
            }

            const mapsFromPeta = sessionStorage.getItem('allSavedMaps');
            if (mapsFromPeta) {
                try {
                    const parsedMapsFromPeta = JSON.parse(mapsFromPeta);
                    if (parsedMapsFromPeta && parsedMapsFromPeta.length > 0) {
                        currentMapGeoJSON = parsedMapsFromPeta;
                        console.log('Loaded allSavedMaps into currentMapGeoJSON:', currentMapGeoJSON);
                    } else if (parsedMapsFromPeta && parsedMapsFromPeta.length === 0) {
                        currentMapGeoJSON = [];
                        console.log('allSavedMaps is empty, clearing currentMapGeoJSON.');
                    }
                    sessionStorage.removeItem('allSavedMaps');
                } catch (e) {
                    console.error('Error parsing allSavedMaps from sessionStorage on load:', e);
                    sessionStorage.removeItem('allSavedMaps');
                    showNotification('Terjadi kesalahan saat memuat peta. Data mungkin korup.', 'error');
                }
            }

            const miniMap = L.map('miniMap').setView([3.4333, 117.6500], 8);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(miniMap);

            const loadedMapLayers = L.featureGroup().addTo(miniMap);

            function saveFormDataToSessionTemp() {
                const formData = {
                    nama_umum: document.getElementById('nama_umum').value,
                    nama_latin: document.getElementById('nama_latin').value,
                    filum: filumSelect.value,
                    sub_filum: subFilumSelect.value,
                    kelas: kelasSelect.value,
                    deskripsi: document.getElementById('deskripsi').value,
                    habitat: document.getElementById('habitat').value,
                    peran_ekologis: document.getElementById('peran_ekologis').value,
                    status_konservasi: document.getElementById('status_konservasi').value,
                    nama_peneliti: document.getElementById('nama_peneliti').value,
                    lokasi_penelitian: document.getElementById('lokasi_penelitian').value,
                    metode_penelitian: document.getElementById('metode_penelitian').value,
                    tanggal_penelitian: document.getElementById('tanggal_penelitian').value,
                    gambar: currentImages,
                };
                sessionStorage.setItem('tempEditSpeciesFormData', JSON.stringify(formData));
                console.log('Form data (excluding map) saved to tempEditSpeciesFormData:', formData);
            }

            const tempEditFormDataString = sessionStorage.getItem('tempEditSpeciesFormData');
            if (tempEditFormDataString) {
                try {
                    const tempEditFormData = JSON.parse(tempEditFormDataString);
                    document.getElementById('nama_umum').value = tempEditFormData.nama_umum || '';
                    document.getElementById('nama_latin').value = tempEditFormData.nama_latin || '';
                    document.getElementById('deskripsi').value = tempEditFormData.deskripsi || '';
                    document.getElementById('habitat').value = tempEditFormData.habitat || '';
                    document.getElementById('peran_ekologis').value = tempEditFormData.peran_ekologis || '';
                    document.getElementById('status_konservasi').value = tempEditFormData.status_konservasi || '';
                    document.getElementById('nama_peneliti').value = tempEditFormData.nama_peneliti || '';
                    document.getElementById('lokasi_penelitian').value = tempEditFormData.lokasi_penelitian || '';
                    document.getElementById('metode_penelitian').value = tempEditFormData.metode_penelitian || '';
                    document.getElementById('tanggal_penelitian').value = tempEditFormData.tanggal_penelitian || '';

                    currentImages = tempEditFormData.gambar || [];
                    renderImagePreviews();

                    loadClassificationOptions();

                    setTimeout(() => {
                        filumSelect.value = tempEditFormData.filum || '';
                        populateSubPhylum();
                        setTimeout(() => {
                            subFilumSelect.value = tempEditFormData.sub_filum || '';
                            populateKelas();
                            setTimeout(() => {
                                kelasSelect.value = tempEditFormData.kelas || '';
                            }, 50);
                        }, 50);
                    }, 50);

                    sessionStorage.removeItem('tempEditSpeciesFormData');
                    console.log('tempEditSpeciesFormData removed from sessionStorage.');
                } catch (e) {
                    console.error('Error parsing tempEditSpeciesFormData from sessionStorage:', e);
                    sessionStorage.removeItem('tempEditSpeciesFormData');
                }
            }


            function renderAllSavedMaps() {
                mapListContainer.innerHTML = '';
                loadedMapLayers.clearLayers();

                let mapsToRender = currentMapGeoJSON;

                if (mapsToRender.length === 0) {
                    console.log("Tidak ada peta tersimpan.");
                    return;
                }

                let bounds = new L.LatLngBounds([]);

                mapsToRender.forEach((mapCollection, index) => {
                    const layer = L.geoJSON(mapCollection, {
                        style: {
                            color: '#007bff',
                            weight: 3,
                            fillColor: '#007bff',
                            fillOpacity: 0.2
                        }
                    }).addTo(loadedMapLayers);

                    if (layer.getBounds().isValid()) {
                        bounds.extend(layer.getBounds());
                    }

                    const newMapItem = document.createElement('div');
                    newMapItem.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-200';
                    newMapItem.dataset.mapIndex = index;

                    newMapItem.innerHTML = `
                        <span class="text-gray-800">Peta ${index + 1}</span>
                        <div class="flex items-center space-x-3">
                            <button class="text-gray-500 hover:text-gray-700 transition-colors view-map-btn" title="Lihat Peta"><i class="fas fa-eye"></i></button>
                            <button class="text-gray-500 hover:text-gray-700 transition-colors edit-map-btn" title="Edit Peta"><i class="fas fa-pencil-alt"></i></button>
                            <button class="text-gray-500 hover:text-gray-700 transition-colors delete-map-btn" title="Hapus Peta"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    mapListContainer.appendChild(newMapItem);

                    const deleteButton = newMapItem.querySelector('.delete-map-btn');
                    if (deleteButton) {
                        deleteButton.addEventListener('click', function () {
                            const mapIndexToDelete = parseInt(this.closest('div[data-map-index]').dataset.mapIndex);
                            currentMapGeoJSON.splice(mapIndexToDelete, 1);
                            showNotification('Peta berhasil dihapus dari daftar.', 'success');
                            renderAllSavedMaps();
                        });
                    }

                    const viewButton = newMapItem.querySelector('.view-map-btn');
                    if (viewButton) {
                        viewButton.addEventListener('click', function () {
                            loadedMapLayers.clearLayers();
                            const selectedMapIndex = parseInt(this.closest('div[data-map-index]').dataset.mapIndex);
                            const mapToDisplay = mapsToRender[selectedMapIndex];

                            L.geoJSON(mapToDisplay, {
                                style: {
                                    color: '#007bff',
                                    weight: 3,
                                    fillColor: '#007bff',
                                    fillOpacity: 0.2
                                }
                            }).addTo(loadedMapLayers);

                            if (loadedMapLayers.getLayers().length > 0) {
                                miniMap.fitBounds(loadedMapLayers.getBounds());
                            }
                        });
                    }

                    const editMapBtn = newMapItem.querySelector('.edit-map-btn');
                    if (editMapBtn) {
                        editMapBtn.addEventListener('click', function () {
                            const selectedMapIndex = parseInt(this.closest('div[data-map-index]').dataset.mapIndex);
                            saveFormDataToSessionTemp();
                            sessionStorage.setItem('allSavedMaps', JSON.stringify(currentMapGeoJSON));
                            window.location.href = `tambahPeta.html?editMapFromSpeciesIndex=${editIndex}&mapIndexToEdit=${selectedMapIndex}`;
                        });
                    }
                });

                if (bounds.isValid()) {
                    miniMap.fitBounds(bounds);
                } else {
                    miniMap.setView([3.4333, 117.6500], 8);
                }
            }

            addMapButton.addEventListener('click', function (event) {
                event.preventDefault();
                saveFormDataToSessionTemp();
                sessionStorage.setItem('allSavedMaps', JSON.stringify(currentMapGeoJSON));
                window.location.href = `tambahPeta.html?editMapFromSpeciesIndex=${editIndex}`;
            });

            viewAllMapsButton.addEventListener('click', function () {
                console.log('editSpesies.html: Viewing all saved maps.');
                renderAllSavedMaps();
            });

            window.addEventListener('resize', function () {
                miniMap.invalidateSize();
            });

            function renderImagePreviews() {
                imagePreviewContainer.innerHTML = '';
                currentImages.forEach((base64Image, index) => {
                    imageCounter++;

                    const itemWrapper = document.createElement('div');
                    itemWrapper.className = 'flex flex-col items-center space-y-2';

                    const thumbnailDiv = document.createElement('div');
                    thumbnailDiv.className = 'relative w-32 h-32 border border-gray-300 rounded-lg flex-shrink-0 overflow-hidden';
                    thumbnailDiv.id = `image-thumbnail-${imageCounter}`;

                    const img = document.createElement('img');
                    img.src = base64Image;
                    img.alt = `Uploaded Image ${imageCounter}`;
                    img.className = 'w-full h-full object-cover';

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 text-xs hover:bg-red-600 transition-colors z-10';
                    deleteButton.innerHTML = '<i class="fas fa-times"></i>';
                    deleteButton.title = 'Hapus Gambar';
                    deleteButton.addEventListener('click', function () {
                        itemWrapper.remove();
                        currentImages.splice(index, 1);
                        showNotification('Gambar berhasil dihapus.', 'success');
                        console.log(`Gambar di indeks ${index} dihapus.`);
                    });

                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.className = 'text-gray-700 text-sm truncate w-32 text-center';
                    fileNameSpan.textContent = `Gambar ${index + 1}`;

                    thumbnailDiv.appendChild(img);
                    thumbnailDiv.appendChild(deleteButton);
                    itemWrapper.appendChild(thumbnailDiv);
                    itemWrapper.appendChild(fileNameSpan);

                    imagePreviewContainer.appendChild(itemWrapper);
                });
            }

            imageUploadInput.addEventListener('change', function (event) {
                const files = event.target.files;
                console.log(`Jumlah file yang dipilih: ${files.length}`);

                if (files.length > 0) {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        console.log(`Memproses file ${i + 1}: ${file.name}, Tipe: ${file.type}`);
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                console.log(`FileReader berhasil memuat untuk ${file.name}`);
                                currentImages.push(e.target.result);
                                renderImagePreviews();
                                showNotification('Gambar berhasil diunggah.', 'success');
                            };
                            reader.onerror = function () {
                                console.error(`Gagal memuat file: ${file.name}`);
                                showNotification(`Gagal memuat gambar: ${file.name}.`, 'error');
                            };
                            reader.readAsDataURL(file);
                        } else {
                            console.log(`File ${file.name} bukan file gambar. Melewatkan.`);
                            showNotification(`File ${file.name} bukan format gambar yang didukung (JPG/PNG).`, 'error');
                        }
                    }
                }
            });

            saveButton.addEventListener('click', function (event) {
                event.preventDefault();

                const nama_umum = document.getElementById('nama_umum').value.trim();
                const nama_latin = document.getElementById('nama_latin').value.trim();
                const filum = filumSelect.value.trim();
                const sub_filum = subFilumSelect.value.trim(); // Get value from select
                const kelas = kelasSelect.value.trim(); // Get value from select
                const deskripsi = document.getElementById('deskripsi').value.trim();
                const habitat = document.getElementById('habitat').value.trim();
                const peran_ekologis = document.getElementById('peran_ekologis').value.trim();
                const status_konservasi = document.getElementById('status_konservasi').value.trim();

                const emptyFields = [];

                if (!nama_umum) emptyFields.push('Nama Umum');
                if (!nama_latin) emptyFields.push('Nama Latin');
                if (!filum) emptyFields.push('Phylum');

                const currentPhylumSubPhylums = allClassificationRecords.find(c => c.phylum === filum)?.sub_phylum || [];
                // Check if a sub_filum selection is required based on available sub_phylums AND it's not the NO_SUBPHYLUM_DATA_VALUE
                if (filum && currentPhylumSubPhylums.some(sp => sp.name !== NO_SUBPHYLUM_DATA_VALUE) && !sub_filum) {
                    emptyFields.push('Sub Phylum');
                }
                if (!kelas) emptyFields.push('Kelas');
                if (!deskripsi) emptyFields.push('Deskripsi');
                if (!habitat) emptyFields.push('Habitat');
                if (!peran_ekologis) emptyFields.push('Peran Ekologis');
                if (!status_konservasi) emptyFields.push('Status Konservasi');

                if (currentImages.length === 0) {
                    emptyFields.push('Gambar');
                }

                if (currentMapGeoJSON.length === 0) {
                    emptyFields.push('Peta Persebaran');
                }

                if (emptyFields.length > 0) {
                    showNotification(`Harap lengkapi: ${emptyFields.join(', ')}.`, 'error');
                    return;
                }

                const nama_peneliti = document.getElementById('nama_peneliti').value.trim();
                const lokasi_penelitian = document.getElementById('lokasi_penelitian').value.trim();
                const metode_penelitian = document.getElementById('metode_penelitian').value.trim();
                const tanggal_penelitian = document.getElementById('tanggal_penelitian').value.trim();

                const peta_persebaran = currentMapGeoJSON;

                const updatedSpeciesData = {
                    nama_umum,
                    nama_latin,
                    filum,
                    sub_filum, // Simpan nama sub phylum (bisa jadi "Tidak Ada Sub Phylum" string)
                    kelas,
                    gambar: currentImages,
                    deskripsi,
                    habitat,
                    peta_persebaran,
                    peran_ekologis,
                    status_konservasi,
                    nama_peneliti,
                    lokasi_penelitian,
                    metode_penelitian,
                    tanggal_penelitian,
                    status_publikasi: 'Unpublish'
                };

                const allSpeciesRecordsString = sessionStorage.getItem('allSpeciesRecords');
                let allSpeciesRecords = allSpeciesRecordsString ? JSON.parse(allSpeciesRecordsString) : [];

                try {
                    if (editIndex !== null && allSpeciesRecords[editIndex]) {
                        allSpeciesRecords[editIndex] = updatedSpeciesData;
                        // --- SET NOTIFICATION FOR THE NEXT PAGE ---
                        sessionStorage.setItem('notificationMessage', 'Data spesies berhasil diperbarui!');
                        sessionStorage.setItem('notificationType', 'success');
                    } else {
                        console.error('Error: editIndex tidak valid atau spesies tidak ditemukan untuk diperbarui.');
                        showNotification('Gagal memperbarui data: Spesies tidak ditemukan.', 'error');
                        return;
                    }

                    sessionStorage.setItem('allSpeciesRecords', JSON.stringify(allSpeciesRecords));
                    sessionStorage.removeItem('allSavedMaps');
                    window.location.href = 'daftarSpesies.html'; // Navigate to daftarSpesies.html
                } catch (e) {
                    console.error('Error saving allSpeciesRecords to sessionStorage:', e);
                    showNotification('Gagal menyimpan data spesies. Data mungkin terlalu besar.', 'error');
                }
            });

            cancelButton.addEventListener('click', function () {
                sessionStorage.removeItem('allSavedMaps');
                sessionStorage.removeItem('tempEditSpeciesFormData');
                window.location.href = 'daftarSpesies.html';
            });

            renderAllSavedMaps();
        });
    </script>
</body>

</html>