<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Klasifikasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* Global Styles */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f0f2f5;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Fixed Sidebar Styling */
        .fixed-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 50;
        }

        /* Adjust main content margin to prevent overlap with fixed sidebar */
        .main-content-margin {
            margin-left: 16rem;
        }

        /* Styling for modals (mapModal, confirmModal) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Styling for the map inside the modal */
        #modalMap {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
        }

        /* Notification styling */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            display: none;
            /* Hidden by default */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .fixed-sidebar {
                position: relative;
                width: 100%;
                height: auto;
                border-radius: 0;
            }

            .main-content-margin {
                margin-left: 0;
            }

            .flex-col.md\:flex-row {
                flex-direction: column;
            }
        }

        .table-col-no {
            width: 1%;
            white-space: nowrap;
            text-align: center;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        /* Paginasi styles */
        .pagination-button {
            @apply flex items-center justify-center min-w-[36px] h-9 px-3 text-sm font-semibold cursor-pointer;
            @apply bg-white text-gray-700 hover:bg-gray-100 transition-colors duration-200;
        }

        /* Tombol aktif */
        .pagination-button.active {
            @apply bg-[#F97A00] text-white border-[#F97A00] hover:bg-[#E06C00];
        }

        /* Tombol disabled */
        .pagination-button.disabled {
            @apply opacity-50 cursor-not-allowed bg-gray-100 text-gray-400;
        }

        /* Styling untuk ellipsis (jika ada) */
        .pagination-ellipsis {
            @apply flex items-center justify-center min-w-[36px] h-9 px-3 text-gray-700 text-sm;
            @apply border border-gray-300 rounded-lg;
        }

        /* Custom Orange for 'Tambah Data' button */
        .bg-orange-custom {
            background-color: #F97A00;
        }

        .hover\:bg-orange-darker-custom:hover {
            background-color: #E06C00;
        }

        /* Styles for the list of classes in the modal */
        #tempKelasList {
            max-height: 12rem;
            /* Ditingkatkan untuk menampilkan lebih banyak item */
            overflow-y: auto;
        }

        #tempKelasList li {
            @apply flex justify-between items-center bg-gray-100 p-2 rounded-md mb-2;
        }

        #tempKelasList li .remove-kelas-btn {
            @apply text-red-500 hover:text-red-700 font-bold ml-4 cursor-pointer;
        }

        /* Gaya tambahan untuk sel tabel agar rapi */
        .table-cell-content {
            vertical-align: top;
            /* Pastikan konten rata atas */
            padding-top: 0.5rem;
            /* Sesuaikan padding agar konten tidak terlalu rapat */
            padding-bottom: 0.5rem;
        }

        /* Gaya untuk setiap item di dalam sel tabel agar ada pemisah */
        .item-wrapper div {
            border-bottom: 1px solid #e2e8f0;
            /* Border tipis di bawah setiap item */
            padding-bottom: 0.25rem;
            /* Sedikit padding di bawah teks */
            margin-bottom: 0.25rem;
            /* Sedikit margin di bawah border */
        }

        .item-wrapper div:last-child {
            border-bottom: none;
            /* Hapus border bawah untuk item terakhir */
            padding-bottom: 0;
            margin-bottom: 0;
        }
    </style>
</head>

<body class="flex min-h-screen">

    <aside class="w-64 bg-green-700 text-white flex flex-col p-4 rounded-r-lg shadow-lg fixed-sidebar">
        <div class="flex items-center justify-center mb-10 mt-4">
            <div class="w-20 h-20 flex items-center justify-center p-2">
                <img src="logo.png" alt="Snail Logo" class="w-full h-full object-contain">
            </div>
        </div>
        <nav class="flex-grow">
            <ul>
                <li class="mb-4">
                    <a href="daftarSpesies.html"
                        class="flex items-center p-3 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-bug text-xl mr-3"></i>
                        <span class="font-medium text-lg">Invertebrata</span>
                    </a>
                </li>
                <li class="mb-4">
                    <a href="daftarKlasifikasi.html" class="flex items-center p-3 rounded-lg bg-green-800 shadow-md">
                        <i class="fas fa-sitemap text-xl mr-3"></i>
                        <span class="font-medium text-lg">Klasifikasi</span>
                    </a>
                </li>
                <li class="mb-4">
                    <a href="daftarKomentar.html"
                        class="flex items-center p-3 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-comment-alt text-xl mr-3"></i>
                        <span class="font-medium text-lg">Komentar</span>
                    </a>
                </li>
                <li class="mb-4">
                    <a href="daftarAkun.html"
                        class="flex items-center p-3 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-users text-xl mr-3"></i>
                        <span class="font-medium text-lg">Akun Pengguna</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto pt-4 border-t border-green-600">
            <a href="index.html" class="flex items-center p-3 rounded-lg hover:bg-green-600 transition-colors">
                <i class="fas fa-sign-out-alt text-xl mr-3"></i>
                <span class="font-medium text-lg">Logout</span>
            </a>
        </div>
    </aside>

    <main class="flex-1 p-8 main-content-margin">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Daftar Klasifikasi</h1>
        </header>

        <div id="notification" class="notification text-white font-semibold"></div>

        <section class="flex flex-col md:flex-row items-center justify-between bg-white p-6 rounded-xl shadow-md mb-8">
            <div class="relative flex-grow w-full md:w-auto mr-0 md:mr-4 mb-4 md:mb-0">
                <input type="text" placeholder="Cari klasifikasi..." id="searchInput"
                    class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full md:w-auto">
                <button
                    class="flex items-center justify-center px-6 py-3 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 transition-colors">
                    <i class="fas fa-filter mr-2"></i>
                    Filter
                </button>
                <a href="tambahPhylum.html"
                    class="px-6 py-3 bg-orange-custom text-white font-semibold rounded-lg shadow-md hover:bg-orange-darker-custom transition-colors flex items-center">
                    <i class="fas fa-plus mr-2"></i> Tambah Data
                </a>
            </div>
        </section>

        <section class="bg-white p-8 rounded-xl shadow-md">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider table-col-no">
                                No.
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Phylum
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Sub Phylum
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Kelas
                            </th>
                            <th scope="col"
                                class="relative px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Aksi
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="classificationTableBody">
                    </tbody>
                </table>
            </div>
            <div id="emptyTableMessage" class="text-center text-gray-500 py-4 hidden">
                Tidak ada data klasifikasi yang ditemukan.
            </div>
        </section>

        <div class="flex flex-col md:flex-row items-center justify-between mt-8">
            <div class="mb-4 md:mb-0 text-gray-700">
                Menampilkan <span id="paginationInfoStart">0</span> sampai <span id="paginationInfoEnd">0</span> dari
                <span id="paginationInfoTotal">0</span> entri
            </div>

            <nav class="flex justify-end">
                <div class="inline-flex rounded-md shadow-sm -space-x-px" role="group">
                    <button type="button" id="prevPageButton"
                        class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-orange-700 focus:z-10 focus:ring-2 focus:ring-orange-700 focus:text-orange-700">
                        Previous
                    </button>
                    <div id="pageNumbersContainer" class="inline-flex">
                    </div>
                    <button type="button" id="nextPageButton"
                        class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-md hover:bg-gray-100 hover:text-orange-700 focus:z-10 focus:ring-2 focus:ring-orange-700 focus:text-orange-700">
                        Next
                    </button>
                </div>
            </nav>

            <div class="flex items-center text-gray-700 mt-4 md:mt-0">
                <span class="mr-2">Rows Per Page:</span>
                <div class="relative inline-block text-left">
                    <select id="rowsPerPageSelect"
                        class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-2 pr-8 rounded-lg shadow leading-tight focus:outline-none focus:shadow-outline">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="confirmModal" class="modal">
        <div class="modal-content max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-gray-800" id="confirmModalTitle"></h3>
            <p class="text-gray-700 mb-6" id="confirmModalMessage"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancelConfirmButton"
                    class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition-colors">
                    Batal
                </button>
                <button id="confirmActionButton"
                    class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors">
                    Ya
                </button>
            </div>
        </div>
    </div>

    <div id="kelasModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeKelasModalButton">&times;</span>
            <h3 class="text-2xl font-semibold mb-4 text-gray-800" id="kelasModalTitle">Edit Kelas</h3>
            <div class="space-y-4">
                <div>
                    <label for="subPhylumSelect" class="block text-sm font-medium text-gray-700 mb-2">Pilih Sub
                        Phylum</label>
                    <select id="subPhylumSelect"
                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    </select>
                </div>
                <div class="flex items-end space-x-2">
                    <div class="flex-grow">
                        <label for="kelasInput" class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                        <input type="text" id="kelasInput" name="kelasInput"
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm"
                            placeholder="Masukkan nama Kelas (e.g., Hydrozoa)">
                    </div>
                    <button type="button" id="addKelasButton"
                        class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors h-fit">
                        Tambah
                    </button>
                </div>
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Daftar Kelas untuk <span
                            id="selectedSubPhylumName" class="font-semibold"></span>:</h4>
                    <ul id="tempKelasList" class="border border-gray-200 rounded-md p-2 max-h-48 overflow-y-auto">
                    </ul>
                    <p id="emptyKelasListMessage" class="text-gray-500 text-sm mt-2 hidden">Belum ada kelas ditambahkan
                        untuk Sub Phylum ini.
                    </p>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelKelasButton"
                        class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition-colors">
                        Batal
                    </button>
                    <button type="button" id="saveKelasButton"
                        class="px-4 py-2 bg-green-700 text-white font-semibold rounded-lg shadow-md hover:bg-green-800 transition-colors">
                        Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const classificationTableBody = document.getElementById('classificationTableBody');
            const notificationDiv = document.getElementById('notification');

            const confirmModal = document.getElementById('confirmModal');
            const confirmActionButton = document.getElementById('confirmActionButton');
            const cancelConfirmButton = document.getElementById('cancelConfirmButton');
            const confirmModalTitle = document.getElementById('confirmModalTitle');
            const confirmModalMessage = document.getElementById('confirmModalMessage');
            let actionToConfirm = null;
            let itemIndexToConfirm = null;
            let classificationDataForConfirmation = null;

            // Elemen Modal Kelas
            const kelasModal = document.getElementById('kelasModal');
            const closeKelasModalButton = document.getElementById('closeKelasModalButton');
            const kelasModalTitle = document.getElementById('kelasModalTitle');
            const subPhylumSelect = document.getElementById('subPhylumSelect');
            const selectedSubPhylumName = document.getElementById('selectedSubPhylumName');
            const kelasInput = document.getElementById('kelasInput');
            const addKelasButton = document.getElementById('addKelasButton');
            const tempKelasList = document.getElementById('tempKelasList');
            const emptyKelasListMessage = document.getElementById('emptyKelasListMessage');
            const saveKelasButton = document.getElementById('saveKelasButton');
            const cancelKelasButton = document.getElementById('cancelKelasButton');

            let currentPhylumIndex = null; // Index of the main classification entry (Phylum)
            let currentSubPhylumIndex = null; // Index of the sub phylum being edited
            let tempKelasArray = []; // Array sementara untuk kelas yang sedang diedit di modal

            const searchInput = document.getElementById('searchInput');
            const emptyTableMessage = document.getElementById('emptyTableMessage');
            const paginationInfoStart = document.getElementById('paginationInfoStart');
            const paginationInfoEnd = document.getElementById('paginationInfoEnd');
            const paginationInfoTotal = document.getElementById('paginationInfoTotal');
            const prevPageButton = document.getElementById('prevPageButton');
            const nextPageButton = document.getElementById('nextPageButton');
            const pageNumbersContainer = document.getElementById('pageNumbersContainer');
            const rowsPerPageSelect = document.getElementById('rowsPerPageSelect');

            let allClassificationData = [];
            let filteredClassificationData = [];
            let visualRowsData = [];

            let currentPage = 1;
            let rowsPerPage;

            // Define a constant for the default sub-phylum name when a phylum has no explicit sub-phylums
            const NO_SUBPHYLUM_NAME = "Tidak Ada Sub Phylum"; // Changed from "(Tidak Ada Sub Phylum)" to remove parentheses

            function showNotification(message, type = 'success') {
                notificationDiv.textContent = message;
                notificationDiv.className = 'notification text-white font-semibold';

                if (type === 'success') {
                    notificationDiv.classList.add('bg-green-500');
                } else if (type === 'error') {
                    notificationDiv.classList.add('bg-red-500');
                } else if (type === 'info') {
                    notificationDiv.classList.add('bg-blue-500');
                } else {
                    notificationDiv.classList.add('bg-gray-500');
                }

                notificationDiv.style.display = 'block';
                setTimeout(() => {
                    notificationDiv.style.display = 'none';
                }, 3000);
            }

            const notificationMessage = sessionStorage.getItem('notificationMessage');
            const notificationType = sessionStorage.getItem('notificationType');
            if (notificationMessage && notificationType) {
                showNotification(notificationMessage, notificationType);
                sessionStorage.removeItem('notificationMessage');
                sessionStorage.removeItem('notificationType');
            }

            function loadClassificationData() {
                const storedData = sessionStorage.getItem('allClassificationRecords');
                if (storedData) {
                    try {
                        allClassificationData = JSON.parse(storedData);
                        allClassificationData.forEach(item => {
                            // Normalisasi sub_phylum: memastikan setiap Phylum memiliki array sub_phylum
                            if (!Array.isArray(item.sub_phylum)) {
                                item.sub_phylum = item.sub_phylum ? [{ name: item.sub_phylum, kelas: [] }] : [];
                            } else {
                                item.sub_phylum = item.sub_phylum.map(sp => {
                                    if (typeof sp === 'string') {
                                        return { name: sp, kelas: [] };
                                    }
                                    if (!Array.isArray(sp.kelas)) {
                                        sp.kelas = sp.kelas ? [sp.kelas] : [];
                                    }
                                    return sp;
                                });
                            }

                            // Migrasi kelas dari level root ke sub_phylum dummy jika ada dan sub_phylum kosong
                            if (item.kelas && Array.isArray(item.kelas) && item.kelas.length > 0) {
                                let noSubPhylumEntry = item.sub_phylum.find(sp => sp.name === NO_SUBPHYLUM_NAME);
                                if (!noSubPhylumEntry) {
                                    noSubPhylumEntry = { name: NO_SUBPHYLUM_NAME, kelas: [] };
                                    item.sub_phylum.unshift(noSubPhylumEntry); // Tambahkan di awal agar mudah ditemukan
                                }
                                noSubPhylumEntry.kelas.push(...item.kelas);
                                delete item.kelas; // Hapus properti kelas dari level root
                            }
                        });
                        console.log('Data klasifikasi berhasil dimuat dan dinormalisasi:', allClassificationData);
                    } catch (e) {
                        console.error('Gagal mengurai data klasifikasi dari sessionStorage:', e);
                        allClassificationData = [];
                        showNotification('Data klasifikasi rusak, tidak dapat dimuat.', 'error');
                    }
                } else {
                    allClassificationData = [];
                    console.log('Tidak ada data klasifikasi di sessionStorage.');
                }
                rowsPerPage = parseInt(rowsPerPageSelect.value);
                applySearchAndFilter();
            }

            function applySearchAndFilter() {
                const searchTerm = searchInput.value.toLowerCase();

                filteredClassificationData = allClassificationData.filter(classification => {
                    const matchesPhylum = classification.phylum && classification.phylum.toLowerCase().includes(searchTerm);
                    const matchesSubPhylum = Array.isArray(classification.sub_phylum) &&
                        classification.sub_phylum.some(sp => sp.name.toLowerCase().includes(searchTerm));
                    const matchesKelas = Array.isArray(classification.sub_phylum) &&
                        classification.sub_phylum.some(sp => Array.isArray(sp.kelas) && sp.kelas.some(k => k.toLowerCase().includes(searchTerm)));

                    return matchesPhylum || matchesSubPhylum || matchesKelas;
                });

                filteredClassificationData.forEach((classification, index) => {
                    classification.displayNumber = index + 1;
                });

                visualRowsData = [];
                filteredClassificationData.forEach((classification) => {
                    // Pastikan ada setidaknya satu sub_phylum, bahkan jika itu adalah dummy
                    const subPhylumList = Array.isArray(classification.sub_phylum) && classification.sub_phylum.length > 0
                        ? classification.sub_phylum
                        : [{ name: NO_SUBPHYLUM_NAME, kelas: ['-'] }]; // Tambahkan sub_phylum dummy jika kosong, dengan kelas '-'

                    subPhylumList.forEach((subPhylumObj, subPhylumIndex) => {
                        const kelasList = Array.isArray(subPhylumObj.kelas) && subPhylumObj.kelas.length > 0
                            ? subPhylumObj.kelas
                            : ['-']; // Tetap tampilkan '-' jika tidak ada kelas

                        kelasList.forEach((kelasItem, kelasIndex) => {
                            visualRowsData.push({
                                phylum: classification.phylum,
                                sub_phylum_name: subPhylumObj.name,
                                kelas: kelasItem,
                                originalPhylumIndex: allClassificationData.indexOf(classification),
                                originalSubPhylumIndex: subPhylumIndex,
                                phylumDisplayNumber: classification.displayNumber,
                            });
                        });
                    });
                });

                currentPage = 1;
                renderTableAndPagination();
            }


            function renderTableAndPagination() {
                classificationTableBody.innerHTML = '';

                const totalVisualRecords = visualRowsData.length;
                const totalPages = Math.ceil(totalVisualRecords / rowsPerPage);

                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = totalPages;
                } else if (currentPage === 0 && totalPages > 0) {
                    currentPage = 1;
                } else if (totalPages === 0) {
                    currentPage = 0;
                }

                const visualStartIndex = (currentPage - 1) * rowsPerPage;
                const visualEndIndex = Math.min(visualStartIndex + rowsPerPage, totalVisualRecords);
                const rowsToDisplay = visualRowsData.slice(visualStartIndex, visualEndIndex);

                if (rowsToDisplay.length === 0) {
                    emptyTableMessage.classList.remove('hidden');
                    paginationInfoStart.textContent = 0;
                    paginationInfoEnd.textContent = 0;
                    paginationInfoTotal.textContent = 0;
                    pageNumbersContainer.innerHTML = '';
                } else {
                    emptyTableMessage.classList.add('hidden');

                    let lastRenderedPhylumIndex = null;
                    let lastRenderedSubPhylumIndex = null;

                    rowsToDisplay.forEach((rowData, i) => {
                        const row = document.createElement('tr');
                        const originalPhylum = allClassificationData[rowData.originalPhylumIndex];
                        const originalFilteredIndex = filteredClassificationData.indexOf(originalPhylum);
                        row.className = originalFilteredIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                        let rowContent = '';

                        const isNewPhylumHeaderForThisPage = (rowData.originalPhylumIndex !== lastRenderedPhylumIndex);
                        const isNewSubPhylumHeaderForThisPage = isNewPhylumHeaderForThisPage || (rowData.originalSubPhylumIndex !== lastRenderedSubPhylumIndex);


                        let phylumRowspan = 0;
                        if (isNewPhylumHeaderForThisPage) {
                            for (let j = i; j < rowsToDisplay.length; j++) {
                                if (rowsToDisplay[j].originalPhylumIndex === rowData.originalPhylumIndex) {
                                    phylumRowspan++;
                                } else {
                                    break;
                                }
                            }
                        }

                        let subPhylumRowspan = 0;
                        if (isNewSubPhylumHeaderForThisPage) {
                            for (let j = i; j < rowsToDisplay.length; j++) {
                                if (rowsToDisplay[j].originalPhylumIndex === rowData.originalPhylumIndex &&
                                    rowsToDisplay[j].originalSubPhylumIndex === rowData.originalSubPhylumIndex) {
                                    subPhylumRowspan++;
                                } else {
                                    break;
                                }
                            }
                        }

                        // No. column
                        if (isNewPhylumHeaderForThisPage) {
                            rowContent += `
                                <td class="px-3 py-4 text-sm text-gray-500 table-col-no table-cell-content" rowspan="${phylumRowspan}">
                                    ${rowData.phylumDisplayNumber}
                                </td>
                            `;
                        }

                        // Phylum column
                        if (isNewPhylumHeaderForThisPage) {
                            rowContent += `
                                <td class="px-6 py-4 text-sm text-gray-900 table-cell-content" rowspan="${phylumRowspan}">
                                    ${rowData.phylum || '-'}
                                </td>
                            `;
                        }

                        // Sub Phylum column
                        if (isNewSubPhylumHeaderForThisPage) {
                            const displaySubPhylumName = (rowData.sub_phylum_name === NO_SUBPHYLUM_NAME) ? '-' : rowData.sub_phylum_name;
                            rowContent += `
                                <td class="px-6 py-4 text-sm text-gray-500 table-cell-content" rowspan="${subPhylumRowspan}">
                                    <div class="item-wrapper"><div>${displaySubPhylumName}</div></div>
                                </td>
                            `;
                        }

                        // Kelas column
                        rowContent += `
                            <td class="px-6 py-4 text-sm text-gray-500 table-cell-content">
                                <div class="item-wrapper"><div>${rowData.kelas}</div></div>
                            </td>
                        `;

                        // Aksi column
                        if (isNewPhylumHeaderForThisPage) {
                            rowContent += `
                                <td class="px-6 py-4 text-left text-sm font-medium table-cell-content" rowspan="${phylumRowspan}">
                                    <button class="text-gray-500 hover:text-gray-700 mr-3 edit-kelas-btn" 
                                            data-phylum-index="${rowData.originalPhylumIndex}" 
                                            title="Edit Kelas">
                                        <i class="fas fa-layer-group"></i>
                                    </button>
                                    <a href="editPhylum.html?editIndex=${rowData.originalPhylumIndex}" class="text-gray-500 hover:text-gray-700 mr-3 edit-phylum-btn" title="Edit Phylum/Sub Phylum">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="text-gray-500 hover:text-gray-700 delete-btn" data-index="${rowData.originalPhylumIndex}" title="Hapus Data">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                        }

                        row.innerHTML = rowContent;
                        classificationTableBody.appendChild(row);

                        lastRenderedPhylumIndex = rowData.originalPhylumIndex;
                        lastRenderedSubPhylumIndex = rowData.originalSubPhylumIndex;
                    });
                }

                paginationInfoStart.textContent = totalVisualRecords === 0 ? 0 : visualStartIndex + 1;
                paginationInfoEnd.textContent = visualEndIndex;
                paginationInfoTotal.textContent = totalVisualRecords;

                updatePaginationControls(totalPages, totalVisualRecords, visualStartIndex, visualEndIndex);
                attachEventListeners();
            }

            function updatePaginationControls(totalPages, totalRecords, startIndex, endIndex) {
                pageNumbersContainer.innerHTML = '';

                if (totalPages > 0) {
                    let maxPageButtons = 5;
                    let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
                    let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

                    if (endPage - startPage + 1 < maxPageButtons) {
                        startPage = Math.max(1, endPage - maxPageButtons + 1);
                    }

                    if (startPage > 1) {
                        const firstPageButton = document.createElement('button');
                        firstPageButton.textContent = '1';
                        firstPageButton.classList.add(
                            'px-4', 'py-2', 'text-sm', 'font-medium', 'h-9', 'flex', 'items-center', 'justify-center',
                            'text-gray-900', 'bg-white', 'border-r', 'border-gray-200',
                            'hover:bg-gray-100', 'hover:text-orange-700',
                            'focus:z-10', 'focus:ring-2', 'focus:ring-orange-700', 'focus:text-orange-700'
                        );
                        firstPageButton.addEventListener('click', () => {
                            currentPage = 1;
                            renderTableAndPagination();
                        });
                        pageNumbersContainer.appendChild(firstPageButton);
                        if (startPage > 2) {
                            const ellipsisSpan = document.createElement('span');
                            ellipsisSpan.textContent = '...';
                            ellipsisSpan.classList.add(
                                'px-4', 'py-2', 'text-sm', 'font-medium', 'h-9', 'flex', 'items-center', 'justify-center',
                                'text-gray-700', 'border-t', 'border-b', 'border-l', 'border-gray-200'
                            );
                            pageNumbersContainer.appendChild(ellipsisSpan);
                        }
                    }

                    for (let i = startPage; i <= endPage; i++) {
                        const pageButton = document.createElement('button');
                        pageButton.textContent = i;

                        pageButton.classList.add(
                            'px-4', 'py-2', 'text-sm', 'font-medium', 'h-9', 'flex', 'items-center', 'justify-center',
                            'text-gray-900', 'bg-white', 'border-t', 'border-b', 'border-l', 'border-gray-200',
                            'hover:bg-gray-100', 'hover:text-orange-700',
                            'focus:z-10', 'focus:ring-2', 'focus:ring-orange-700', 'focus:text-orange-700'
                        );

                        if (i === currentPage) {
                            pageButton.classList.remove(
                                'text-gray-900', 'bg-white', 'border-gray-200', 'hover:bg-gray-100', 'hover:text-orange-700', 'focus:text-orange-700', 'focus:ring-orange-700'
                            );
                            pageButton.classList.add(
                                'text-white', 'bg-orange-500', 'border-orange-500', 'hover:bg-orange-600',
                                'focus:text-white', 'focus:ring-white'
                            );
                        }

                        pageButton.addEventListener('click', () => {
                            currentPage = i;
                            renderTableAndPagination();
                        });
                        pageNumbersContainer.appendChild(pageButton);
                    }

                    if (endPage < totalPages) {
                        if (endPage < totalPages - 1) {
                            const ellipsisSpan = document.createElement('span');
                            ellipsisSpan.textContent = '...';
                            ellipsisSpan.classList.add(
                                'px-4', 'py-2', 'text-sm', 'font-medium', 'h-9', 'flex', 'items-center', 'justify-center',
                                'text-gray-700', 'border-t', 'border-b', 'border-l', 'border-gray-200'
                            );
                            pageNumbersContainer.appendChild(ellipsisSpan);
                        }
                        const lastPageButton = document.createElement('button');
                        lastPageButton.textContent = totalPages;
                        lastPageButton.classList.add(
                            'px-4', 'py-2', 'text-sm', 'font-medium', 'h-9', 'flex', 'items-center', 'justify-center',
                            'text-gray-900', 'bg-white', 'border-t', 'border-b', 'border-l', 'border-gray-200',
                            'hover:bg-gray-100', 'hover:text-orange-700',
                            'focus:z-10', 'focus:ring-2', 'focus:ring-orange-700', 'focus:text-orange-700'
                        );
                        lastPageButton.addEventListener('click', () => {
                            currentPage = totalPages;
                            renderTableAndPagination();
                        });
                        pageNumbersContainer.appendChild(lastPageButton);
                    }

                    if (pageNumbersContainer.lastChild) {
                        pageNumbersContainer.lastChild.classList.add('border-r');
                    }
                }

                prevPageButton.classList.toggle('disabled', currentPage === 1 || totalPages === 0);
                nextPageButton.classList.toggle('disabled', currentPage === totalPages || totalPages === 0);
            }

            function deleteClassification(index) {
                if (index >= 0 && index < allClassificationData.length) {
                    allClassificationData.splice(index, 1);
                    sessionStorage.setItem('allClassificationRecords', JSON.stringify(allClassificationData));
                    showNotification('Data klasifikasi berhasil dihapus.', 'success');
                    applySearchAndFilter();
                }
            }

            function attachEventListeners() {
                classificationTableBody.removeEventListener('click', handleTableButtonClick);
                classificationTableBody.addEventListener('click', handleTableButtonClick);
            }

            function handleTableButtonClick(event) {
                const target = event.target.closest('.delete-btn, .edit-kelas-btn, .edit-phylum-btn');
                if (!target) return;

                if (target.classList.contains('delete-btn')) {
                    const indexString = target.dataset.index;
                    const index = parseInt(indexString);
                    if (isNaN(index)) {
                        console.error('Invalid index found:', indexString);
                        return;
                    }
                    actionToConfirm = 'delete';
                    itemIndexToConfirm = index;
                    classificationDataForConfirmation = allClassificationData[itemIndexToConfirm];

                    confirmModalTitle.textContent = `Hapus Data No. ${itemIndexToConfirm + 1}?`;
                    confirmModalMessage.textContent = `Hapus data klasifikasi "${classificationDataForConfirmation.phylum || '-'}"?`;
                    confirmActionButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    confirmActionButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    confirmModal.style.display = 'flex';
                } else if (target.classList.contains('edit-kelas-btn')) {
                    currentPhylumIndex = parseInt(target.dataset.phylumIndex);
                    const phylumEntry = allClassificationData[currentPhylumIndex];

                    subPhylumSelect.innerHTML = ''; // Clear existing options

                    // Prioritaskan mencari dan memilih sub_phylum dummy terlebih dahulu jika ada
                    let dummySubPhylumIdx = -1;
                    if (phylumEntry && Array.isArray(phylumEntry.sub_phylum)) {
                        dummySubPhylumIdx = phylumEntry.sub_phylum.findIndex(sp => sp.name === NO_SUBPHYLUM_NAME);
                    }

                    // Tambahkan opsi sub_phylum yang sebenarnya atau dummy
                    if (phylumEntry && Array.isArray(phylumEntry.sub_phylum) && phylumEntry.sub_phylum.length > 0) {
                        phylumEntry.sub_phylum.forEach((sp, idx) => {
                            const option = document.createElement('option');
                            option.value = idx; // Gunakan indeks sebagai nilai
                            option.textContent = (sp.name === NO_SUBPHYLUM_NAME) ? '-' : sp.name; // Tampilkan '-' jika nama dummy
                            subPhylumSelect.appendChild(option);
                        });
                        // Atur currentSubPhylumIndex ke dummy jika ada, atau yang pertama jika tidak ada dummy
                        currentSubPhylumIndex = (dummySubPhylumIdx !== -1) ? dummySubPhylumIdx : 0;
                        subPhylumSelect.value = currentSubPhylumIndex; // Atur nilai dropdown yang dipilih

                        selectedSubPhylumName.textContent = (phylumEntry.sub_phylum[currentSubPhylumIndex].name === NO_SUBPHYLUM_NAME) ? '-' : phylumEntry.sub_phylum[currentSubPhylumIndex].name;
                        tempKelasArray = [...phylumEntry.sub_phylum[currentSubPhylumIndex].kelas]; // Deep copy
                    } else {
                        // Kasus ini seharusnya jarang terjadi jika normalisasi loadClassificationData sudah benar
                        // Tapi sebagai fallback, jika phylum.sub_phylum benar-benar kosong
                        const option = document.createElement('option');
                        option.value = "0"; // Indeks 0 untuk dummy
                        option.textContent = '-'; // Tampilkan '-'
                        subPhylumSelect.appendChild(option);

                        // Buat entri dummy di data asli jika belum ada
                        const newDummyEntry = { name: NO_SUBPHYLUM_NAME, kelas: [] };
                        phylumEntry.sub_phylum.push(newDummyEntry);
                        currentSubPhylumIndex = 0;

                        selectedSubPhylumName.textContent = '-';
                        tempKelasArray = [];
                    }

                    renderTempKelasList();
                    kelasInput.value = '';
                    kelasModalTitle.textContent = 'Edit Kelas';
                    kelasModal.style.display = 'flex';

                } else if (target.classList.contains('edit-phylum-btn')) {
                    const indexString = target.dataset.index;
                    const index = parseInt(indexString);
                    if (isNaN(index)) {
                        console.error('Invalid index found:', indexString);
                        return;
                    }
                    window.location.href = `editPhylum.html?editIndex=${index}`;
                }
            }

            // Event listener for subPhylumSelect change
            subPhylumSelect.addEventListener('change', function () {
                currentSubPhylumIndex = parseInt(this.value); // Value is the index of the sub_phylum object
                const phylumEntry = allClassificationData[currentPhylumIndex];

                if (phylumEntry && phylumEntry.sub_phylum[currentSubPhylumIndex]) {
                    // Update tampilan nama sub phylum dan tempKelasArray berdasarkan pilihan dropdown
                    selectedSubPhylumName.textContent = (phylumEntry.sub_phylum[currentSubPhylumIndex].name === NO_SUBPHYLUM_NAME) ? '-' : phylumEntry.sub_phylum[currentSubPhylumIndex].name;
                    tempKelasArray = [...phylumEntry.sub_phylum[currentSubPhylumIndex].kelas]; // Load classes for selected sub phylum
                } else {
                    selectedSubPhylumName.textContent = "Error: Sub Phylum tidak ditemukan";
                    tempKelasArray = [];
                }
                kelasInput.value = '';
                renderTempKelasList();
            });


            confirmActionButton.onclick = function () {
                if (itemIndexToConfirm !== null) {
                    if (actionToConfirm === 'delete') {
                        deleteClassification(itemIndexToConfirm);
                    }
                    confirmModal.style.display = 'none';
                    actionToConfirm = null;
                    itemIndexToConfirm = null;
                    classificationDataForConfirmation = null;
                }
            };

            cancelConfirmButton.onclick = function () {
                confirmModal.style.display = 'none';
                actionToConfirm = null;
                itemIndexToConfirm = null;
                classificationDataForConfirmation = null;
            };

            closeKelasModalButton.onclick = function () {
                kelasModal.style.display = 'none';
                resetKelasModalState();
            };

            cancelKelasButton.onclick = function () {
                kelasModal.style.display = 'none';
                resetKelasModalState();
            };

            function resetKelasModalState() {
                kelasInput.value = '';
                currentPhylumIndex = null;
                currentSubPhylumIndex = null;
                tempKelasArray = [];
                subPhylumSelect.innerHTML = ''; // Clear options
                selectedSubPhylumName.textContent = "";
            }


            addKelasButton.onclick = function () {
                const newKelas = kelasInput.value.trim();
                if (newKelas) {
                    if (currentPhylumIndex !== null && currentSubPhylumIndex !== null) {
                        const phylumEntry = allClassificationData[currentPhylumIndex];
                        if (phylumEntry && phylumEntry.sub_phylum[currentSubPhylumIndex]) {
                            if (!tempKelasArray.includes(newKelas)) {
                                tempKelasArray.push(newKelas);
                                kelasInput.value = '';
                                renderTempKelasList();
                            } else {
                                showNotification('Kelas ini sudah ada dalam daftar untuk Sub Phylum yang dipilih!', 'info');
                            }
                        } else {
                            showNotification('Data Sub Phylum tidak ditemukan untuk penambahan kelas.', 'error');
                        }
                    } else {
                        showNotification('Silakan pilih Phylum dan Sub Phylum terlebih dahulu!', 'error');
                    }
                } else {
                    showNotification('Nama kelas tidak boleh kosong!', 'error');
                }
            };


            function renderTempKelasList() {
                tempKelasList.innerHTML = '';
                if (tempKelasArray.length === 0) {
                    emptyKelasListMessage.classList.remove('hidden');
                } else {
                    emptyKelasListMessage.classList.add('hidden');
                    tempKelasArray.forEach((kelas, index) => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <span>${kelas}</span>
                            <button type="button" class="remove-kelas-btn" data-index="${index}">&times;</button>
                        `;
                        tempKelasList.appendChild(listItem);
                    });
                }
                tempKelasList.querySelectorAll('.remove-kelas-btn').forEach(button => {
                    button.onclick = (event) => {
                        const indexToRemove = parseInt(event.target.dataset.index);
                        tempKelasArray.splice(indexToRemove, 1);
                        renderTempKelasList();
                    };
                });
            }

            saveKelasButton.onclick = function () {
                if (currentPhylumIndex !== null && currentSubPhylumIndex !== null) {
                    const phylumEntry = allClassificationData[currentPhylumIndex];
                    if (phylumEntry && phylumEntry.sub_phylum[currentSubPhylumIndex]) {
                        phylumEntry.sub_phylum[currentSubPhylumIndex].kelas = [...tempKelasArray];
                        sessionStorage.setItem('allClassificationRecords', JSON.stringify(allClassificationData));
                        showNotification('Kelas berhasil diperbarui!', 'success');
                        applySearchAndFilter();
                        kelasModal.style.display = 'none';
                        resetKelasModalState();
                    } else {
                        showNotification('Terjadi kesalahan saat menyimpan kelas: Sub Phylum tidak ditemukan.', 'error');
                    }
                } else {
                    showNotification('Terjadi kesalahan: Phylum atau Sub Phylum tidak dipilih.', 'error');
                }
            };

            window.onclick = function (event) {
                if (event.target === confirmModal) {
                    confirmModal.style.display = 'none';
                    actionToConfirm = null;
                    itemIndexToConfirm = null;
                    classificationDataForConfirmation = null;
                } else if (event.target === kelasModal) {
                    kelasModal.style.display = 'none';
                    resetKelasModalState();
                }
            };

            prevPageButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTableAndPagination();
                }
            });

            nextPageButton.addEventListener('click', () => {
                const totalPages = Math.ceil(visualRowsData.length / rowsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTableAndPagination();
                }
            });

            rowsPerPageSelect.addEventListener('change', (event) => {
                rowsPerPage = parseInt(event.target.value);
                currentPage = 1;
                renderTableAndPagination();
            });

            searchInput.addEventListener('input', applySearchAndFilter);

            loadClassificationData();
        });
    </script>
</body>

</html>